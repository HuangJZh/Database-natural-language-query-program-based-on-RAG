<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åŸºäºRAGçš„è‡ªç„¶è¯­è¨€SQLæŸ¥è¯¢ é¡¹ç›®å®ä¾‹æ¼”ç¤º</title>
  <style>
    /* Formal presentation styling */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
    :root{
      --bg:#f5f7fa;
      --card:#ffffff;
      --accent:#1f6feb;
      --muted:#6b7280;
      --border:#e6e9ef;
    }
    html,body{height:100%;margin:0;padding:0;}
    body { 
      font-family: 'Roboto', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; 
      margin: 0;
      padding: 24px;
      background: var(--bg); 
      color:#0f172a;
      width: 100%;
      box-sizing: border-box;
    }
    .container {
      max-width: none;
      width: 100%;
      margin: 0 auto;
    }
    header{
      display:flex;
      align-items:flex-start;
      gap:14px;
      width: 100%;
    }
    h1 { 
      margin:0; 
      font-size:1.8rem; 
      color:var(--accent); 
      font-weight:700;
      word-wrap: break-word;
    }
    .logo-bubble{
      width:48px;
      height:48px;
      border-radius:8px;
      background:var(--accent);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:700;
      box-shadow:0 2px 8px rgba(31,111,235,0.12);
      flex-shrink: 0;
    }
    p.small { 
      font-size:0.95rem; 
      color:var(--muted); 
      margin-top:6px;
      word-wrap: break-word;
    }

    /* cards */
    .card{
      background:var(--card); 
      padding:16px; 
      border-radius:8px; 
      box-shadow:0 2px 8px rgba(16,24,40,0.04); 
      margin-top:12px; 
      border:1px solid var(--border);
      width: 100%;
      box-sizing: border-box;
    }
    textarea{
      width:100%;
      height:120px;
      padding:12px;
      border-radius:6px;
      border:1px solid var(--border);
      font-size:1rem;
      box-sizing:border-box;
      resize: vertical;
    }
    /* limit the question textarea width so it doesn't span the full page when left column is wide */
    #question{
      max-width:100%;
    }
    pre{
      background:#fafbfd;
      padding:12px;
      border-radius:6px;
      overflow:auto;
      border:1px solid var(--border);
      word-wrap: break-word;
      white-space: pre-wrap;
      max-width: 100%;
    }
    .controls{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap: wrap;
      width: 100%;
    }
    button{
      background:var(--accent);
      color:#fff;
      border:none;
      padding:10px 14px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      white-space: nowrap;
    }
    button:disabled{
      background:#cbd5e1;
      color:#94a3b8;
      cursor:not-allowed;
    }
    button.ghost{
      background:transparent;
      color:var(--accent);
      border:1px solid var(--border);
    }
    .small{
      font-size:0.9rem;
      color:var(--muted);
    }
    .row{
      display:flex;
      gap:12px;
      align-items:flex-start;
      width: 100%;
      flex-wrap: wrap;
    }
    .col{
      flex: 1;
      min-width: 300px;
      box-sizing: border-box;
    }
    #history{
      max-height:320px;
      overflow:auto;
      word-break:break-word;
      width: 100%;
    }
    .stat{
      display:inline-block;
      min-width:160px;
      margin-right:12px;
      color:var(--muted);
    }
    .muted{
      color:var(--muted);
    }
    .badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:6px;
      background:#f1f5f9;
      border:1px solid var(--border);
      font-weight:600;
      color:var(--muted);
      white-space: nowrap;
    }
    
    /* æˆåŠŸç‡ç»Ÿè®¡æ ·å¼ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .stat-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 0.9rem;
      color: var(--muted);
    }
    .stat-good {
      color: #10b981;
    }
    .stat-average {
      color: #f59e0b;
    }
    .stat-poor {
      color: #ef4444;
    }
    
    /* è¡¨æ ¼æ ·å¼ */
    .result-table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 8px; 
      font-size: 0.9rem; 
      overflow-x: auto;
      display: block;
    }
    .result-table th { 
      background: #f8fafc; 
      text-align: left; 
      padding: 8px 12px; 
      border-bottom: 1px solid var(--border); 
      font-weight: 600; 
      color: var(--muted); 
      white-space: nowrap;
    }
    .result-table td { 
      padding: 8px 12px; 
      border-bottom: 1px solid #f1f5f9; 
      word-break: break-word;
    }
    .result-table tr:last-child td { 
      border-bottom: none; 
    }
    .result-info { 
      color: var(--muted); 
      font-size: 0.9rem; 
      margin-top: 8px; 
      word-break: break-word;
    }

    /* æµ‹è¯•ç»“æœæ ·å¼ */
    .test-result-block {
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      background: #fafbfc;
    }
    .test-sql-section {
      background: white;
      border-radius: 6px;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #e9ecef;
    }
    .similarity-info {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    .similarity-item {
      padding: 4px 8px;
      border-radius: 4px;
      background: #f8f9fa;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      body {
        padding: 16px;
      }
      
      .row {
        flex-direction: column;
      }
      
      .col {
        min-width: 100%;
        width: 100%;
      }
      
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .stat {
        display: block;
        margin-right: 0;
        margin-bottom: 8px;
        min-width: auto;
      }
      
      #question {
        height: 100px;
      }
      
      .similarity-info {
        flex-direction: column;
        gap: 8px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 12px;
      }
      
      h1 {
        font-size: 1.3rem;
      }
      
      .card {
        padding: 12px;
      }
      
      button {
        padding: 8px 12px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo-bubble">RAG</div>
      <div>
        <h1>åŸºäºRAGçš„è‡ªç„¶è¯­è¨€SQLæŸ¥è¯¢ é¡¹ç›®å®ä¾‹æ¼”ç¤º</h1>
        <p class="small">NIS3351æ•°æ®åº“åŸç†ä¸å®‰å…¨è¯¾ç¨‹å¤§ä½œä¸šï¼Œåœ¨æœ¬åœ°è¿è¡Œçš„ FastAPI æœåŠ¡ä¸Šæ¼”ç¤º RAG åˆ° SQL çš„æŸ¥è¯¢æµç¨‹ã€‚</p>
      </div>
    </header>

    <div style="margin-top:12px" class="controls">
      <button id="btn-switch-mode" class="ghost">åˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼</button>
      <div style="flex:1"></div>
      <div id="global-controls">
        <button id="btn-init">åˆå§‹åŒ–ç³»ç»Ÿ</button>
        <span id="init-status" class="badge muted" style="margin-left:10px">æœªåˆå§‹åŒ–</span>
      </div>
    </div>

    <div id="sys" class="card">
      <strong>æœåŠ¡å™¨ / ç³»ç»Ÿ çŠ¶æ€</strong>
      <div id="server-status" class="muted">--</div>
      <div style="margin-top:8px">
        <span class="stat">CPU: <span id="cpu">-</span>%</span>
        <span class="stat">å†…å­˜: <span id="mem">-</span>%</span>
        <span class="stat">GPU å¯ç”¨: <span id="gpu-avail">-</span></span>
        <span class="stat">GPU æ•°é‡: <span id="gpu-count">-</span></span>
      </div>
      <div id="gpu-details" style="margin-top:8px" class="muted"></div>
    </div>

    <hr />
    <div id="chat-page" style="display:none" class="card">
      <div>
        <label style="margin-right:12px"><input type="radio" name="mode" id="mode-rag" value="rag" checked /> æœ‰RAG</label>
        <label style="margin-right:12px"><input type="radio" name="mode" id="mode-no-rag" value="no_rag" /> æ— RAG</label>
        <label><input type="radio" name="mode" id="mode-hybrid" value="hybrid" /> æ··åˆæ¨¡å¼ï¼ˆåŒæ—¶ç”Ÿæˆæœ‰RAGå’Œæ— RAGçš„ SQLï¼‰</label>
      </div>

      <div style="margin-top:12px" class="row">
        <div class="col">
          <div style="margin-top:10px">
            <textarea id="question" placeholder="è¾“å…¥è‡ªç„¶è¯­è¨€é—®é¢˜ï¼ˆä¾‹å¦‚ï¼šæŸ¥è¯¢å‰10ä¸ªç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼‰"></textarea>
            <div style="margin-top:8px">
              <button id="btn-send">å‘é€</button>
              <span id="loading" style="display:none">â³ å¤„ç†ä¸­...</span>
            </div>
          </div>

          <h2>SQLæŸ¥è¯¢ç»“æœ</h2>
          <div>
            <h3>ç”Ÿæˆçš„ SQL</h3>
            <pre id="sql">(none)</pre>

            <h3>æ‰§è¡Œç»“æœ</h3>
            <div id="result-container">
              <div id="result-status" class="result-info"></div>
              <div id="result-table-container"></div>
            </div>

            <h3>é”™è¯¯ / ä¿¡æ¯</h3>
            <pre id="error">(none)</pre>
          </div>
        </div>

        <div class="col" style="min-width: 300px; max-width: 100%;">
          <h2>æŸ¥è¯¢å†å²</h2>
          <div id="history"></div>
        </div>
      </div>
    </div>

    <div id="tests-page" style="display:none" class="card">
      <div style="margin-top:8px" class="controls">
        <button id="btn-run-tests">è¿è¡Œå¯¹æ¯”æµ‹è¯•</button>
        <span id="tests-status" class="badge muted">ç©ºé—²</span>
        <button id="btn-show-stats" class="ghost">æ˜¾ç¤ºç»Ÿè®¡</button>
      </div>
      
      <!-- æˆåŠŸç‡ç»Ÿè®¡ -->
      <div id="success-stats" style="display:none; margin-top:16px; padding:16px; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0;">
        <h3 style="margin-top:0; color:#1f6feb;">ğŸ¯ æµ‹è¯•æ‰§è¡ŒæˆåŠŸç‡ç»Ÿè®¡</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div id="no-rag-exec-success-rate" class="stat-value">0%</div>
            <div class="stat-label">æ— RAG SQLæ‰§è¡ŒæˆåŠŸç‡</div>
          </div>
          <div class="stat-card">
            <div id="with-rag-exec-success-rate" class="stat-value">0%</div>
            <div class="stat-label">æœ‰RAG SQLæ‰§è¡ŒæˆåŠŸç‡</div>
          </div>
        </div>
        <div style="margin-top:12px; font-size:0.9rem; color:#6b7280;">
          <strong>ç»Ÿè®¡è¯´æ˜ï¼š</strong><br>
          â€¢ SQLæ‰§è¡ŒæˆåŠŸç‡ï¼šSQLåœ¨æ•°æ®åº“ä¸­æˆåŠŸæ‰§è¡Œå¹¶è¿”å›ç»“æœ<br>
          â€¢ æ€»æµ‹è¯•æ•°ï¼š<span id="total-tests">0</span> ä¸ªåœºæ™¯
        </div>
      </div>
      
      <div id="tests-results" style="margin-top:12px"></div>
    </div>
  </div>

  <script>
  const btnInit = document.getElementById('btn-init');
  const initStatus = document.getElementById('init-status');
    const btnSend = document.getElementById('btn-send');
    const questionEl = document.getElementById('question');
    const sqlEl = document.getElementById('sql');
    const resultContainer = document.getElementById('result-container');
    const resultStatus = document.getElementById('result-status');
    const resultTableContainer = document.getElementById('result-table-container');
    const errorEl = document.getElementById('error');
    const historyEl = document.getElementById('history');
    const loadingEl = document.getElementById('loading');
    function getSelectedMode(){ const el = document.querySelector('input[name="mode"]:checked'); return el? el.value : 'rag'; }

    const cpuEl = document.getElementById('cpu');
    const memEl = document.getElementById('mem');
    const gpuAvailEl = document.getElementById('gpu-avail');
    const gpuCountEl = document.getElementById('gpu-count');
    const gpuDetailsEl = document.getElementById('gpu-details');

    // æˆåŠŸç‡ç»Ÿè®¡å…ƒç´ 
    const successStatsEl = document.getElementById('success-stats');
    const btnShowStats = document.getElementById('btn-show-stats');
    const noRagSuccessRateEl = document.getElementById('no-rag-success-rate');
    const withRagSuccessRateEl = document.getElementById('with-rag-success-rate');
    const noRagExecSuccessRateEl = document.getElementById('no-rag-exec-success-rate');
    const withRagExecSuccessRateEl = document.getElementById('with-rag-exec-success-rate');
    const totalTestsEl = document.getElementById('total-tests');

    // æ ¼å¼åŒ–æŸ¥è¯¢ç»“æœä¸ºè¡¨æ ¼æ˜¾ç¤ºï¼ˆç±»ä¼¼rag_chat_systemä¸­çš„display_resultæ–¹æ³•ï¼‰
    function formatResultAsTable(result) {
      if (!result || !Array.isArray(result) || result.length === 0) {
        return '<div class="result-info">ğŸ“‹ æŸ¥è¯¢ç»“æœ: æ— æ•°æ®</div>';
      }

      const columns = Object.keys(result[0]);
      let html = `<div class="result-info">ğŸ“‹ æŸ¥è¯¢ç»“æœ (${result.length} è¡Œ):</div>`;
      html += '<div style="overflow-x: auto;">';
      html += '<table class="result-table">';
      
      // è¡¨å¤´
      html += '<thead><tr>';
      columns.forEach(col => {
        html += `<th>${escapeHtml(col)}</th>`;
      });
      html += '</tr></thead>';
      
      // è¡¨ä½“
      html += '<tbody>';
      result.forEach(row => {
        html += '<tr>';
        columns.forEach(col => {
          const value = row[col];
          html += `<td>${escapeHtml(String(value !== null && value !== undefined ? value : ''))}</td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      
      return html;
    }

    // æ ¼å¼åŒ–æµ‹è¯•ç»“æœä¸ºè¡¨æ ¼æ˜¾ç¤º
    function formatTestResultAsTable(result) {
      if (!result || !Array.isArray(result) || result.length === 0) {
        return '<div class="result-info">ğŸ“‹ æŸ¥è¯¢ç»“æœ: æ— æ•°æ®</div>';
      }

      const columns = Object.keys(result[0]);
      let html = `<div class="result-info">ğŸ“‹ æŸ¥è¯¢ç»“æœ (${result.length} è¡Œ):</div>`;
      html += '<div style="overflow-x: auto;">';
      html += '<table class="result-table">';
      
      // è¡¨å¤´
      html += '<thead><tr>';
      columns.forEach(col => {
        html += `<th>${escapeHtml(col)}</th>`;
      });
      html += '</tr></thead>';
      
      // è¡¨ä½“
      html += '<tbody>';
      result.forEach(row => {
        html += '<tr>';
        columns.forEach(col => {
          const value = row[col];
          html += `<td>${escapeHtml(String(value !== null && value !== undefined ? value : ''))}</td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      
      return html;
    }

    async function fetchStatus(){
      try{
        const r = await fetch('/status');
        const j = await r.json();
        initStatus.textContent = j.initialized ? 'å·²åˆå§‹åŒ–' : (j.initializing ? 'åˆå§‹åŒ–ä¸­...' : 'æœªåˆå§‹åŒ–');
        // disable init button while initializing or after initialized
        if(j.initialized){
          btnInit.disabled = true;
          btnInit.textContent = 'å·²åˆå§‹åŒ–';
        }else if(j.initializing){
          btnInit.disabled = true;
          btnInit.textContent = 'åˆå§‹åŒ–ä¸­...';
        }else{
          btnInit.disabled = false;
          btnInit.textContent = 'åˆå§‹åŒ–ç³»ç»Ÿ';
        }
        const sys = j.system || {};
        cpuEl.textContent = sys.cpu_percent ?? '-';
        memEl.textContent = sys.mem_percent ?? '-';
        gpuAvailEl.textContent = sys.gpu_available ? 'æ˜¯' : 'å¦';
        gpuCountEl.textContent = sys.gpu_count ?? 0;
        gpuDetailsEl.innerHTML = '';
        if(Array.isArray(sys.gpus)){
          sys.gpus.forEach(g=>{
            const div = document.createElement('div');
            div.style.borderTop='1px solid #eee'; div.style.padding='6px 0';
            div.innerHTML = `<b>GPU ${g.id}ï¼š</b> ${g.name || 'æœªçŸ¥'} <br> å·²åˆ†é…ï¼š${g.allocated || 0} / å·²ä¿ç•™: ${g.reserved || 0}` + (g.nvidia_smi? `<br/>NVIDIA-SMI ä¿¡æ¯ï¼šGPUå ç”¨ ${g.nvidia_smi.gpu}% ï¼›å†…å­˜å ç”¨ ${g.nvidia_smi.mem_util}% ï¼›å·²ç”¨ ${g.nvidia_smi.mem_used_mb}MB / ${g.nvidia_smi.mem_total_mb}MBã€‚` : '');
            gpuDetailsEl.appendChild(div);
          });
        }
      }catch(e){
        initStatus.textContent = 'æœªæ£€æµ‹åˆ°æœåŠ¡';
        cpuEl.textContent = '-'; memEl.textContent='-'; gpuAvailEl.textContent='-'; gpuCountEl.textContent='-';
      }
    }

    // è·å–å¹¶æ˜¾ç¤ºæˆåŠŸç‡ç»Ÿè®¡
    async function fetchSuccessStats() {
      try {
          const response = await fetch('/success_stats');
          const stats = await response.json();
          
          if (response.ok) {
              // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
              totalTestsEl.textContent = stats.total_tests || 0;
              
              // è®¾ç½®æ‰§è¡ŒæˆåŠŸç‡å¹¶æ·»åŠ é¢œè‰²ç±»
              updateStatWithColor(noRagExecSuccessRateEl, stats.no_rag_exec_success_rate);
              updateStatWithColor(withRagExecSuccessRateEl, stats.with_rag_exec_success_rate);
              
              // å¦‚æœæµ‹è¯•æ­£åœ¨è¿è¡Œï¼Œæ˜¾ç¤ºå®æ—¶è¿›åº¦
              if (btnRunTests.dataset.running === '1') {
                  const noRagCount = stats.no_rag_exec_success_count || 0;
                  const withRagCount = stats.with_rag_exec_success_count || 0;
                  const total = stats.total_tests || 0;
                  
                  // åœ¨ç»Ÿè®¡å¡ç‰‡ä¸Šæ˜¾ç¤ºå®æ—¶è®¡æ•°
                  noRagExecSuccessRateEl.title = `æˆåŠŸ: ${noRagCount}/${total}`;
                  withRagExecSuccessRateEl.title = `æˆåŠŸ: ${withRagCount}/${total}`;
              }
          }
      } catch (e) {
          console.warn('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', e);
      }
    }

    const style = document.createElement('style');
    style.textContent = `
        .stat-card {
            position: relative;
            cursor: help;
        }
        .stat-card:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
        }
    `;
    document.head.appendChild(style);

    // æ ¹æ®æˆåŠŸç‡è®¾ç½®é¢œè‰²
    function updateStatWithColor(element, rate) {
      element.textContent = `${rate}%`;
      element.className = 'stat-value'; // é‡ç½®ç±»
      
      if (rate >= 80) {
        element.classList.add('stat-good');
      } else if (rate >= 60) {
        element.classList.add('stat-average');
      } else {
        element.classList.add('stat-poor');
      }
    }

    function escapeHtml(s){
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

  const btnSwitch = document.getElementById('btn-switch-mode');
    const chatPage = document.getElementById('chat-page');
    const testsPage = document.getElementById('tests-page');
    const btnRunTests = document.getElementById('btn-run-tests');
    const testsStatus = document.getElementById('tests-status');
    const testsResults = document.getElementById('tests-results');

    function showTab(which){
      if(which === 'chat'){
        chatPage.style.display = '';
        testsPage.style.display = 'none';
      }else{
        chatPage.style.display = 'none';
        testsPage.style.display = '';
      }
    }

    // åˆ‡æ¢æ¨¡å¼æŒ‰é’®
    let mode = 'chat';
    btnSwitch.addEventListener('click', ()=>{
      if(mode === 'chat'){
        mode = 'tests';
        btnSwitch.textContent = 'åˆ‡æ¢åˆ°å¯¹è¯æ¨¡å¼';
        showTab('tests');
      }else{
        mode = 'chat';
        btnSwitch.textContent = 'åˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼';
        showTab('chat');
      }
    });

    // æ˜¾ç¤º/éšè—ç»Ÿè®¡ä¿¡æ¯
    btnShowStats.addEventListener('click', () => {
      if (successStatsEl.style.display === 'none') {
        successStatsEl.style.display = 'block';
        btnShowStats.textContent = 'éšè—ç»Ÿè®¡';
        fetchSuccessStats(); // æ˜¾ç¤ºæ—¶è·å–æœ€æ–°ç»Ÿè®¡
      } else {
        successStatsEl.style.display = 'none';
        btnShowStats.textContent = 'æ˜¾ç¤ºç»Ÿè®¡';
      }
    });

    btnInit.addEventListener('click', async ()=>{
      btnInit.disabled = true;
      initStatus.textContent = 'å¼€å§‹åˆå§‹åŒ–...(å¯èƒ½è€—æ—¶)';
      try{
        const r = await fetch('/init', {method:'POST'});
        const j = await r.json();
        initStatus.textContent = j.status || JSON.stringify(j);
        // poll status until initialized
        const poll = setInterval(async ()=>{
          const s = await fetch('/status');
          const sj = await s.json();
          initStatus.textContent = sj.initialized ? 'å·²åˆå§‹åŒ–' : (sj.initializing ? 'åˆå§‹åŒ–ä¸­...' : 'æœªåˆå§‹åŒ–');
          // keep button disabled while initializing or after initialized
          btnInit.disabled = sj.initialized || sj.initializing;
          if(sj.initialized){
            btnInit.textContent = 'å·²åˆå§‹åŒ–';
          }else if(sj.initializing){
            btnInit.textContent = 'åˆå§‹åŒ–ä¸­...';
          }else{
            btnInit.textContent = 'åˆå§‹åŒ–ç³»ç»Ÿ';
          }
          if(sj.initialized || !sj.initializing){
            clearInterval(poll);
            loadHistory();
          }
        }, 2000);
      }catch(e){
        initStatus.textContent = 'Initialization failed (check console)';
        console.error(e);
        btnInit.disabled = false;
      }
    });

    // Start tests non-blocking and show structured per-test progress; button becomes a Terminate button while running
    btnRunTests.addEventListener('click', async ()=>{
      // If a run is already active, this click acts as a terminate request
      if(btnRunTests.dataset.running === '1'){
        try{
          btnRunTests.disabled = true;
          btnRunTests.textContent = 'æ­£åœ¨å‘é€ç»ˆæ­¢è¯·æ±‚...';
          await fetch('/run_tests_stop', {method:'POST'});
        }catch(e){ console.warn('stop request failed', e); }
        return;
      }

      // Begin a new test run
      testsStatus.textContent = 'è¿è¡Œä¸­';
      testsResults.innerHTML = '';
      btnRunTests.dataset.running = '1';
      btnRunTests.textContent = 'ç»ˆæ­¢';

      try{
        const r = await fetch('/run_tests_start', {method:'POST'});
        if(!r.ok){
          const t = await r.json();
          testsResults.innerText = JSON.stringify(t);
          testsStatus.textContent = 'é”™è¯¯';
          btnRunTests.dataset.running = '0';
          btnRunTests.textContent = 'è¿è¡Œå¯¹æ¯”æµ‹è¯•';
          return;
        }
      }catch(e){
        testsStatus.textContent = 'é”™è¯¯';
        testsResults.innerText = String(e);
        btnRunTests.dataset.running = '0';
        btnRunTests.textContent = 'è¿è¡Œå¯¹æ¯”æµ‹è¯•';
        return;
      }

      // Poll structured progress
      const shown = new Set();
      const pollInterval = 1000;
      const poller = setInterval(async ()=>{
        try{
            const resp = await fetch('/run_tests_progress');
            if(!resp.ok) return;
            const jp = await resp.json();
            const running = Boolean(jp.running);
            const results = Array.isArray(jp.results) ? jp.results : [];

            // æ¯æ¬¡è½®è¯¢éƒ½æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ— è®ºæµ‹è¯•æ˜¯å¦è¿è¡Œï¼‰
            await fetchSuccessStats();

            // å¦‚æœæµ‹è¯•æ­£åœ¨è¿è¡Œï¼Œæ›´é¢‘ç¹åœ°æ›´æ–°ç»Ÿè®¡ï¼ˆæ¯2ç§’ï¼‰
            if (running) {
                setTimeout(fetchSuccessStats, 2000);
            }

            // Render any new results in order
            for(let i=0;i<results.length;i++){
                if(shown.has(i)) continue;
                const item = results[i] || {};
                const q = escapeHtml(item.question || item.prompt || '');
                const withRag = escapeHtml(item.sql_with_rag || item.sql_with_rag_text || item.sql || '');
                const noRag = escapeHtml(item.sql_no_rag || item.sql_no_rag_text || item.sql_no_rag || '');
                
                // è·å–æ‰§è¡Œç»“æœ
                const noRagExec = item.no_rag_exec || {};
                const withRagExec = item.with_rag_exec || {};

                const div = document.createElement('div');
                div.className = 'test-result-block';
                
                let resultHtml = `<div style="margin-bottom: 12px;"><b>é—®é¢˜${i+1}ï¼š${escapeHtml(item.name || '')}</b></div>`;
                resultHtml += `<div style="margin-bottom: 16px; padding: 8px; background: #f0f4f8; border-radius: 4px;">${q}</div>`;

                // æœ‰RAGéƒ¨åˆ†
                resultHtml += `<div class="test-sql-section">`;
                resultHtml += `<div style="font-weight: 600; color: #1f6feb; margin-bottom: 8px;">æœ‰RAGç”ŸæˆSQLï¼š</div>`;
                resultHtml += `<pre style="margin:8px 0; background: #f8f9fa; padding: 10px; border-radius: 4px;">${withRag || '(æ— )'}</pre>`;
                resultHtml += `<div style="margin: 8px 0;"><b>æ‰§è¡ŒçŠ¶æ€ï¼š</b> ${withRagExec.executed ? (withRagExec.success ? '<span style="color:green">âœ… æˆåŠŸ</span>' : '<span style="color:red">âŒ å¤±è´¥</span>') : '<span style="color:#666">â¸ï¸ æœªæ‰§è¡Œ</span>'}</div>`;

                if(withRagExec.executed){
                    if(withRagExec.success){
                        resultHtml += `<div style="margin-top:10px"><b>æŸ¥è¯¢ç»“æœï¼š</b>${formatTestResultAsTable(withRagExec.result||[])}</div>`;
                    }else{
                        resultHtml += `<div style="margin-top:10px"><b>é”™è¯¯ä¿¡æ¯ï¼š</b><pre style="background: #fff5f5; color: #c53030;">${escapeHtml(String(withRagExec.error||''))}</pre></div>`;
                    }
                }
                resultHtml += `</div>`;

                // æ— RAGéƒ¨åˆ†
                resultHtml += `<div class="test-sql-section">`;
                resultHtml += `<div style="font-weight: 600; color: #1f6feb; margin-bottom: 8px;">æ— RAGç”ŸæˆSQLï¼š</div>`;
                resultHtml += `<pre style="margin:8px 0; background: #f8f9fa; padding: 10px; border-radius: 4px;">${noRag || '(æ— )'}</pre>`;
                resultHtml += `<div style="margin: 8px 0;"><b>æ‰§è¡ŒçŠ¶æ€ï¼š</b> ${noRagExec.executed ? (noRagExec.success ? '<span style="color:green">âœ… æˆåŠŸ</span>' : '<span style="color:red">âŒ å¤±è´¥</span>') : '<span style="color:#666">â¸ï¸ æœªæ‰§è¡Œ</span>'}</div>`;

                if(noRagExec.executed){
                    if(noRagExec.success){
                        resultHtml += `<div style="margin-top:10px"><b>æŸ¥è¯¢ç»“æœï¼š</b>${formatTestResultAsTable(noRagExec.result||[])}</div>`;
                    }else{
                        resultHtml += `<div style="margin-top:10px"><b>é”™è¯¯ä¿¡æ¯ï¼š</b><pre style="background: #fff5f5; color: #c53030;">${escapeHtml(String(noRagExec.error||''))}</pre></div>`;
                    }
                }
                resultHtml += `</div>`;
                

                div.innerHTML = resultHtml;
                testsResults.appendChild(div);
                shown.add(i);
            }

            testsStatus.textContent = running ? 'è¿è¡Œä¸­' : 'å·²å®Œæˆ';

            if(!running){
                clearInterval(poller);
                btnRunTests.dataset.running = '0';
                btnRunTests.textContent = 'è¿è¡Œå¯¹æ¯”æµ‹è¯•';
                btnRunTests.disabled = false;

                // æµ‹è¯•å®Œæˆåæœ€ç»ˆæ›´æ–°ç»Ÿè®¡
                setTimeout(fetchSuccessStats, 500);

                // append a brief footer with final count if available
                try{
                    const res = await fetch('/run_tests_result');
                    if(res.ok){
                        const jr = await res.json();
                        if(Array.isArray(jr.results)){
                            const footer = document.createElement('div');
                            footer.style.marginTop='16px'; 
                            footer.style.paddingTop='12px'; 
                            footer.style.borderTop='2px dashed #e1e5e9';
                            footer.style.textAlign = 'center';
                            footer.style.fontWeight = '600';
                            footer.innerHTML = `<div style="color: #1f6feb;">âœ… æµ‹è¯•å®Œæˆï¼Œå…± ${jr.results.length} æ¡ç»“æœ</div>`;
                            testsResults.appendChild(footer);
                        }
                    }
                }catch(e){ /* ignore */ }
            }
        }catch(e){
            console.warn('poll error', e);
        }
      }, pollInterval);
    });

    async function loadHistory(){
      try{
        const r = await fetch('/history');
        if(!r.ok){ historyEl.innerText = 'æ— å†å²è®°å½•ï¼ˆç³»ç»Ÿæœªåˆå§‹åŒ–ï¼‰'; return; }
        const h = await r.json();
        historyEl.innerHTML = '';
        // show newest first
        for(let i=h.length-1;i>=0;i--){
          const item = h[i];
          const div = document.createElement('div');
          div.style.borderTop = '1px solid #eee';
          div.style.padding = '8px 0';

          const time = item.time || '';
          const question = item.question || '';

          let inner = `<div style="font-size:0.95rem;color:var(--muted)"><b>æ—¶é—´ï¼š</b> ${time}</div>`;
          inner += `<div style="margin-top:6px"><b>é—®é¢˜ï¼š</b> ${escapeHtml(question)}</div>`;

          if(item.mode === 'hybrid'){
            const no_sql = item.sql_no_rag || '';
            const with_sql = item.sql_with_rag || '';
            const no_exec = item.no_rag_exec || {};
            const with_exec = item.with_rag_exec || {};

            inner += `<div style="margin-top:8px"><b>æœ‰RAGç”Ÿæˆç»“æœï¼š</b><pre>${escapeHtml(with_sql) || '(æ— )'}</pre>`;
            inner += `<div><b>æ‰§è¡Œï¼š</b> ${with_exec.executed ? (with_exec.success ? '<span style="color:green">æˆåŠŸ</span>' : '<span style="color:red">å¤±è´¥</span>') : '<span style="color:#666">æœªæ‰§è¡Œ</span>'}</div>`;
            if(with_exec.executed){
              if(with_exec.success){
                inner += `<div style="margin-top:6px"><b>æŸ¥è¯¢ç»“æœï¼š</b>${formatResultAsTable(with_exec.result||[])}</div>`;
              }else{
                inner += `<div style="margin-top:6px"><b>é”™è¯¯ä¿¡æ¯ï¼š</b><pre>${escapeHtml(String(with_exec.error||''))}</pre></div>`;
              }
            }
            inner += `</div>`;

            inner += `<div style="margin-top:8px"><b>æ— RAGç”Ÿæˆç»“æœï¼š</b><pre>${escapeHtml(no_sql) || '(æ— )'}</pre>`;
            inner += `<div><b>æ‰§è¡Œï¼š</b> ${no_exec.executed ? (no_exec.success ? '<span style="color:green">æˆåŠŸ</span>' : '<span style="color:red">å¤±è´¥</span>') : '<span style="color:#666">æœªæ‰§è¡Œ</span>'}</div>`;
            if(no_exec.executed){
              if(no_exec.success){
                inner += `<div style="margin-top:6px"><b>æŸ¥è¯¢ç»“æœï¼š</b>${formatResultAsTable(no_exec.result||[])}</div>`;
              }else{
                inner += `<div style="margin-top:6px"><b>é”™è¯¯ä¿¡æ¯ï¼š</b><pre>${escapeHtml(String(no_exec.error||''))}</pre></div>`;
              }
            }
            inner += `</div>`;
          }else{
            // non-hybrid entry
            const sql = item.sql || item.sql_query || '';
            inner += `<div style="margin-top:8px"><b>ç”Ÿæˆçš„ SQLï¼š</b><pre>${escapeHtml(sql) || '(æ— )'}</pre></div>`;
            inner += `<div style="margin-top:6px"><b>æŸ¥è¯¢æ˜¯å¦æˆåŠŸï¼š</b> ${item.execution_success ? '<span style="color:green">æ˜¯</span>' : '<span style="color:red">å¦</span>'}</div>`;
            if(item.execution_success){
              inner += `<div style="margin-top:6px"><b>æŸ¥è¯¢ç»“æœï¼š</b>${formatResultAsTable(item.execution_result||[])}</div>`;
            }else if(item.error_message){
              inner += `<div style="margin-top:6px"><b>é”™è¯¯ä¿¡æ¯ï¼š</b><pre>${escapeHtml(String(item.error_message))}</pre></div>`;
            }
          }

          div.innerHTML = inner;
          historyEl.appendChild(div);
        }
      }catch(e){ console.warn(e); }
    }

    btnSend.addEventListener('click', async ()=>{
      const question = questionEl.value.trim();
    const selectedMode = getSelectedMode();
    const use_rag = (selectedMode === 'rag');
  if(!question) return alert('è¯·è¾“å…¥é—®é¢˜');
      loadingEl.style.display = '';
      sqlEl.textContent = '(waiting)';
      resultStatus.textContent = '';
      resultTableContainer.innerHTML = '';
      errorEl.textContent = '(waiting)';
      try{
        const r = await fetch('/query', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({question, use_rag, hybrid: (selectedMode === 'hybrid')})
        });
        const j = await r.json();
        if(r.ok){
          // Handle hybrid response (two SQLs)
          if(j.sql_query_with_rag !== undefined || j.sql_query_no_rag !== undefined){
            const withSql = j.sql_query_with_rag || '(æ— )';
            const noSql = j.sql_query_no_rag || '(æ— )';
            sqlEl.innerHTML = `<div><b>æœ‰RAGç”Ÿæˆï¼š</b><pre>${escapeHtml(withSql)}</pre></div><div style="margin-top:6px"><b>æ— RAGç”Ÿæˆï¼š</b><pre>${escapeHtml(noSql)}</pre></div>`;

            // show execution summaries if present
            const noExec = j.no_rag_execution || {};
            const withExec = j.with_rag_execution || {};
            let resultHtml = '';
            resultHtml += `<div><b>æœ‰RAG æ‰§è¡Œï¼š</b> ${withExec.executed ? (withExec.success ? '<span style="color:green">æˆåŠŸ</span>' : '<span style="color:red">å¤±è´¥</span>') : '<span style="color:#666">æœªæ‰§è¡Œ</span>'}</div>`;
            if(withExec.executed){ 
              if(withExec.success){
                resultHtml += formatResultAsTable(withExec.result||[]);
              }else{
                resultHtml += `<pre>${escapeHtml(String(withExec.error||''))}</pre>`;
              }
            }
            resultHtml += `<div style="margin-top:6px"><b>æ— RAG æ‰§è¡Œï¼š</b> ${noExec.executed ? (noExec.success ? '<span style="color:green">æˆåŠŸ</span>' : '<span style="color:red">å¤±è´¥</span>') : '<span style="color:#666">æœªæ‰§è¡Œ</span>'}</div>`;
            if(noExec.executed){ 
              if(noExec.success){
                resultHtml += formatResultAsTable(noExec.result||[]);
              }else{
                resultHtml += `<pre>${escapeHtml(String(noExec.error||''))}</pre>`;
              }
            }
            resultTableContainer.innerHTML = resultHtml;
            errorEl.textContent = '';
          }else{
            sqlEl.textContent = j.sql_query || '(æ—  SQL)';
            if(j.execution_success){
              resultStatus.textContent = `âœ… æŸ¥è¯¢æˆåŠŸï¼Œè¿”å› ${Array.isArray(j.execution_result) ? j.execution_result.length : 0} è¡Œç»“æœ`;
              resultTableContainer.innerHTML = formatResultAsTable(j.execution_result);
              errorEl.textContent = '';
            }else{
              resultStatus.textContent = 'âŒ æŸ¥è¯¢æ‰§è¡Œå¤±è´¥';
              resultTableContainer.innerHTML = '';
              errorEl.textContent = j.error_message || '(æ— é”™è¯¯ä¿¡æ¯)';
            }
          }
          loadHistory();
        }else{
          const text = await r.text();
          errorEl.textContent = text;
          sqlEl.textContent = '';
          resultStatus.textContent = '';
          resultTableContainer.innerHTML = '';
        }
      }catch(e){
        console.error(e);
        errorEl.textContent = String(e);
        resultStatus.textContent = '';
        resultTableContainer.innerHTML = '';
      }finally{
        loadingEl.style.display = 'none';
      }
    });

  // initial status and python output
  fetchStatus();
  setInterval(fetchStatus, 3000);
    // default to chat tab
    showTab('chat');
  </script>
</body>
</html>